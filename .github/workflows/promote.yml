name: Production Promotion

on:
  workflow_dispatch:
    inputs:
      repo_tags:
        description: >-
          Comma-separated repo:tag pairs, e.g.
          chrono-devops:v1.3.0,chrono-api:v2.5.0,chrono-app:v3.1.0
        required: true
        type: string

concurrency:
  group: production-promote
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
    steps:
      - name: Parse and validate repo_tags
        id: parse
        env:
          REPO_TAGS_INPUT: ${{ inputs.repo_tags }}
        run: |
          ALLOWED_REPOS="chrono-devops chrono-api chrono-pipeline-v2 chrono-app chrono-filter-ai-api"
          SEMVER_REGEX="^v[0-9]+\.[0-9]+\.[0-9]+$"

          IFS=',' read -ra PAIRS <<< "$REPO_TAGS_INPUT"

          if [ ${#PAIRS[@]} -eq 0 ]; then
            echo "::error::No repo:tag pairs provided"
            exit 1
          fi

          JSON="["
          FIRST=true

          for pair in "${PAIRS[@]}"; do
            pair="$(echo "$pair" | xargs)"  # trim whitespace

            repo="${pair%%:*}"
            tag="${pair#*:}"

            if [ "$repo" = "$pair" ] || [ -z "$tag" ]; then
              echo "::error::Invalid format '$pair' — expected repo:tag"
              exit 1
            fi

            # Validate repo name
            if ! echo "$ALLOWED_REPOS" | grep -qw "$repo"; then
              echo "::error::Unknown repo '$repo'. Allowed: $ALLOWED_REPOS"
              exit 1
            fi

            # Validate tag is stable semver (no pre-release suffix)
            if ! [[ "$tag" =~ $SEMVER_REGEX ]]; then
              echo "::error::Tag '$tag' for repo '$repo' is not stable semver (expected vX.Y.Z with no suffix)"
              exit 1
            fi

            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              JSON+=","
            fi
            JSON+="{\"repo\":\"$repo\",\"tag\":\"$tag\"}"

            echo "Validated: $repo @ $tag"
          done

          JSON+="]"

          echo "Parsed matrix: $JSON"
          echo "matrix=$JSON" >> "$GITHUB_OUTPUT"

  approve:
    needs: validate
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Confirm approval
        run: echo "Production deployment approved"

  push-tags:
    needs: [validate, approve]
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547  # v1.12.0
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: Quoyi-ChronoTracer
          repositories: chrono-devops,chrono-api,chrono-pipeline-v2,chrono-app,chrono-filter-ai-api

      - name: Mask token
        run: echo "::add-mask::${{ steps.app-token.outputs.token }}"

      - name: Push tags to component repos
        env:
          MATRIX: ${{ needs.validate.outputs.matrix }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          git config --global user.name "ChronoTracer Deploy Bot"
          git config --global user.email "ci@chronotracer.com"
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"

          COUNT=$(echo "$MATRIX" | jq length)
          echo "Pushing tags for $COUNT repo(s)..."
          echo ""

          FAILED=()

          for i in $(seq 0 $(( COUNT - 1 ))); do
            REPO=$(echo "$MATRIX" | jq -r ".[$i].repo")
            TAG=$(echo "$MATRIX" | jq -r ".[$i].tag")

            echo "----------------------------------------"
            echo "[$REPO] Cloning and tagging $TAG"
            echo "----------------------------------------"

            git clone "https://github.com/Quoyi-ChronoTracer/${REPO}.git" "$REPO"
            cd "$REPO"

            # Verify an RC tag exists for this version and resolve its commit
            RC_EXISTS=$(git tag -l "${TAG}-rc.*" | sort -V | tail -1)
            if [ -z "$RC_EXISTS" ]; then
              echo "::error::No RC tag found for ${TAG} in ${REPO}. Cannot promote without staging first."
              FAILED+=("$REPO")
              cd ..
              continue
            fi

            RC_COMMIT=$(git rev-list -n 1 "$RC_EXISTS")
            echo "[$REPO] Promoting commit $RC_COMMIT from $RC_EXISTS"

            git tag -a "$TAG" "$RC_COMMIT" -m "Release $TAG — promoted from $RC_EXISTS"

            if ! git push origin "$TAG" 2>&1; then
              echo "::error::Failed to push $TAG to $REPO"
              FAILED+=("$REPO")
              cd ..
              continue
            fi

            echo "[$REPO] Successfully pushed tag $TAG"
            echo ""

            cd ..
          done

          echo "========================================"
          echo "Production promotion complete."
          echo "Tagged repos:"
          for i in $(seq 0 $(( COUNT - 1 ))); do
            REPO=$(echo "$MATRIX" | jq -r ".[$i].repo")
            TAG=$(echo "$MATRIX" | jq -r ".[$i].tag")
            echo "  - $REPO @ $TAG"
          done
          echo "========================================"

          if [ ${#FAILED[@]} -gt 0 ]; then
            echo ""
            echo "::error::Failed repos: ${FAILED[*]}"
            exit 1
          fi
